<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ndyakurungi ITECH Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    /* Custom styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .dark .modal-content {
      background-color: #1f2937;
      color: white;
    }
    .hidden {
      display: none;
    }
    .gray-button {
      background-color: #6b7280;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-align: center;
      display: inline-block;
      width: auto;
      margin: 5px;
      border: 1px solid black;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }
    .gray-button:hover {
      background-color: #4b5563;
    }
    .close-button {
      background-color: #ef4444;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-align: center;
      display: inline-block;
      width: auto;
      margin: 5px;
      border: 1px solid black;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }
    .close-button:hover {
      background-color: #dc2626;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow">
    <div class="container mx-auto p-4 flex items-center justify-between">
      <div class="flex items-center">
        <div class="text-4xl text-blue-600 dark:text-blue-400 mr-4">
          <img src="Itech-computers-logo1.webp" alt="Itech Computers Logo">
        </div>
        <div>
          <h1 class="text-2xl font-bold dark:text-white">NDYAKURUNGI ITECH COMPUTER SOLUTIONS</h1>
          <p class="text-sm text-gray-600 dark:text-gray-400">Name it, we will provide & deliver it</p>
        </div>
      </div>
      <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700">
        <i id="themeIcon" class="fas fa-moon text-gray-800 dark:text-yellow-400"></i>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container mx-auto p-8">
    <!-- Product and Services Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <!-- Products Card -->
      <div class="product-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
        <h2 class="text-xl font-semibold mb-4 dark:text-white"><i class="fas fa-box-open mr-2"></i>Products Inventory</h2>
        <button onclick="openAddProductModal()" class="gray-button">
          <i class="fas fa-plus mr-2"></i>Add Product
        </button>
        <div class="mt-4">
          <details class="bg-gray-100 dark:bg-gray-700 p-2 rounded">
            <summary class="cursor-pointer dark:text-white">View Products</summary>
            <div id="productList" class="mt-2 space-y-2">
              <!-- Products will be dynamically added here -->
            </div>
          </details>
        </div>
        <button onclick="openStockManagementModal()" class="gray-button mt-4">
          <i class="fas fa-boxes mr-2"></i>Manage Stock
        </button>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="addProductModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-4 dark:text-white"><i class="fas fa-plus mr-2"></i>Product inventory</h3>
      <form id="addProductForm">
        <input type="text" placeholder="Product Name" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:text-white" required>
        <input type="text" placeholder="Product Type" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:text-white" required>
        <input type="number" placeholder="Buying Price" id="buyingPriceInput" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:text-white" required>
        <input type="number" placeholder="Selling Price" id="sellingPriceInput" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:text-white" required readonly>
        <button type="submit" class="gray-button">Add Product</button>
      </form>
      <button onclick="closeModal('addProductModal')" class="close-button mt-2">Close</button>
    </div>
  </div>

  <!-- Stock Management Modal -->
  <div id="stockManagementModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-4 dark:text-white"><i class="fas fa-boxes mr-2"></i>Manage Stock</h3>
      <table class="stock-table">
        <thead>
          <tr>
            <th>Product Name</th>
            <th>Product Type</th>
            <th>Available Quantity</th>
            <th>Total Invested</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="stockTableBody">
          <!-- Stock items will be dynamically added here -->
        </tbody>
      </table>
      <button onclick="openAddStockModal()" class="gray-button mt-4">
        <i class="fas fa-plus mr-2"></i>Add New Quantity
      </button>
      <button onclick="closeModal('stockManagementModal')" class="close-button mt-2">Close</button>
    </div>
  </div>

  <!-- Add Stock Modal -->
  <div id="addStockModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-4 dark:text-white"><i class="fas fa-plus mr-2"></i>Add New Quantity</h3>
      <form id="addStockForm">
        <select id="stockItemSelect" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:text-white" required>
          <option value="" disabled selected>Select Product</option>
          <!-- Product options will be dynamically added here -->
        </select>
        <input type="text" id="productTypeInput" placeholder="Product Type" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:text-white" required readonly>
        <input type="number" id="defaultUnitPriceInput" placeholder="Default Unit Price" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:text-white" required readonly>
        <input type="number" placeholder="Quantity" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:text-white" required>
        <input type="number" placeholder="Price per Unit" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:text-white" required>
        <button type="submit" class="gray-button">Add Quantity</button>
      </form>
      <button onclick="closeModal('addStockModal')" class="close-button mt-2">Close</button>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    const backendUrl = 'https://man-m681.onrender.com'; // Replace with your Render backend URL

    // Dark/Light Mode Toggle
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    themeToggle.addEventListener('click', () => {
      const htmlElement = document.documentElement;
      htmlElement.classList.toggle('dark');
      
      if (htmlElement.classList.contains('dark')) {
        themeIcon.classList.remove('fa-moon');
        themeIcon.classList.add('fa-sun');
      } else {
        themeIcon.classList.remove('fa-sun');
        themeIcon.classList.add('fa-moon');
      }
    });

    // Open Add Product Modal
    function openAddProductModal() {
      document.getElementById('addProductModal').classList.remove('hidden');
    }

    // Open Stock Management Modal
    function openStockManagementModal() {
      document.getElementById('stockManagementModal').classList.remove('hidden');
      fetchStock();
    }

    // Open Add Stock Modal
    function openAddStockModal() {
      fetchProducts().then(products => {
        const stockItemSelect = document.getElementById('stockItemSelect');
        stockItemSelect.innerHTML = '<option value="" disabled selected>Select Product</option>' +
          products.map(product => `<option value="${product.name}" data-type="${product.type}" data-buying-price="${product.buying_price}">${product.name}</option>`).join('');
      });
      document.getElementById('addStockModal').classList.remove('hidden');
    }

    // Close Modals
    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    // Add Product
    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const productName = e.target[0].value;
      const productType = e.target[1].value;
      const buyingPrice = parseFloat(e.target[2].value);
      const sellingPrice = parseFloat(e.target[3].value);

      const response = await fetch(`${backendUrl}/products/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: productName,
          type: productType,
          buying_price: buyingPrice,
          selling_price: sellingPrice
        })
      });

      if (response.ok) {
        alert('Product added successfully!');
        e.target.reset();
        closeModal('addProductModal');
        fetchProducts();
      } else {
        alert('Failed to add product');
      }
    });

    // Add Stock
    document.getElementById('addStockForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const productName = document.getElementById('stockItemSelect').value;
      const productType = document.getElementById('productTypeInput').value;
      const quantity = parseFloat(e.target[2].value);
      const pricePerUnit = parseFloat(e.target[3].value);

      const response = await fetch(`${backendUrl}/stock/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          product_name: productName,
          product_type: productType,
          quantity: quantity,
          price_per_unit: pricePerUnit
        })
      });

      if (response.ok) {
        alert('Stock added successfully!');
        e.target.reset();
        closeModal('addStockModal');
        fetchStock();
      } else {
        alert('Failed to add stock');
      }
    });

    // Fetch Products
    async function fetchProducts() {
      const response = await fetch(`${backendUrl}/products/`);
      const data = await response.json();
      const productList = document.getElementById('productList');
      productList.innerHTML = data.products.map(product => `
        <div class="product-item">
          <span>${product.name} (${product.type})</span>
          <div class="actions">
            <i class="fas fa-trash text-red-500" onclick="deleteProduct('${product.name}', '${product.type}')"></i>
            <i class="fas fa-edit text-blue-500" onclick="editProduct('${product.name}', '${product.type}', ${product.buying_price}, ${product.selling_price})"></i>
            <i class="fas fa-eye text-green-500" onclick="showProductDetails('${product.name}', '${product.type}', ${product.buying_price}, ${product.selling_price})"></i>
          </div>
        </div>
      `).join('');
      return data.products;
    }

    // Fetch Stock
    async function fetchStock() {
      const response = await fetch(`${backendUrl}/stock/`);
      const data = await response.json();
      const stockTableBody = document.getElementById('stockTableBody');
      stockTableBody.innerHTML = data.stock.map(item => `
        <tr>
          <td>${item.product_name} (${item.product_type || 'N/A'})</td>
          <td>${item.product_type || 'N/A'}</td>
          <td>${item.quantity}</td>
          <td>UGX ${(item.price_per_unit * item.quantity).toLocaleString()}</td>
          <td class="actions">
            <i class="fas fa-trash text-red-500 hover:text-red-700 cursor-pointer" onclick="deleteStockItem('${item.product_name}', '${item.product_type}')"></i>
            <i class="fas fa-edit text-blue-500 hover:text-blue-700 cursor-pointer ml-2" onclick="editStockItem('${item.product_name}', '${item.product_type}', ${item.quantity}, ${item.price_per_unit})"></i>
            <i class="fas fa-eye text-green-500 hover:text-green-700 cursor-pointer ml-2" onclick="viewStockItem('${item.product_name}', '${item.product_type}', ${item.quantity}, ${item.price_per_unit})"></i>
          </td>
        </tr>
      `).join('');
    }

    // Delete Product
    async function deleteProduct(productName, productType) {
      if (confirm(`Are you sure you want to delete ${productName} (${productType})?`)) {
        const response = await fetch(`${backendUrl}/products/${productName}/${productType}`, {
          method: 'DELETE',
        });

        if (response.ok) {
          alert('Product deleted successfully!');
          fetchProducts();
        } else {
          alert('Failed to delete product');
        }
      }
    }

    // Delete Stock Item
    async function deleteStockItem(productName, productType) {
      if (confirm(`Are you sure you want to delete ${productName} (${productType})?`)) {
        const response = await fetch(`${backendUrl}/stock/${productName}/${productType}`, {
          method: 'DELETE',
        });

        if (response.ok) {
          alert(`${productName} (${productType}) deleted successfully!`);
          fetchStock();
        } else {
          alert('Failed to delete stock item');
        }
      }
    }

    // Initialize
    fetchProducts();
    fetchStock();
  </script>
</body>
</html>
